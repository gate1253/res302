name: Deploy res302 Worker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js (use Node 20 to satisfy wrangler engine)
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Show Node / npm versions (debug)
        run: |
          node -v
          npm -v

      - name: Set Git user (optional)
        run: |
          git config --global user.name "${{ secrets.GIT_USER_NAME || 'github-actions[bot]' }}"
          git config --global user.email "${{ secrets.GIT_USER_EMAIL || 'github-actions[bot]@users.noreply.github.com' }}"

      - name: Create wrangler.toml from secrets
        env:
          # CF_ACCOUNT_ID 네임스페이스 ID
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # RES302_KV 네임스페이스 ID
          RES302_KV: ${{ secrets.RES302_KV }}
          # REQ_TIME_KV 네임스페이스 ID
          REQ_TIME_KV: ${{ secrets.REQ_TIME_KV }}
          # REQ_COUNT_KV 네임스페이스 ID
          REQ_COUNT_KV: ${{ secrets.REQ_COUNT_KV }}
        run: |
          # Use unquoted heredoc to allow shell variable expansion
          cat > wrangler.toml <<EOF
          name = "res302"
          main = "workers/res302-worker.js"
          type = "module"
          compatibility_date = "2025-11-08"
          account_id = "${CF_ACCOUNT_ID}"
          kv_namespaces = [
            { binding = "RES302_KV", id = "${RES302_KV}" },
            { binding = "REQ_TIME_KV", id = "${REQ_TIME_KV}" },
            { binding = "REQ_COUNT_KV", id = "${REQ_COUNT_KV}"
          ]
          EOF
          echo "wrangler.toml created."
          echo "---- wrangler.toml ----"
          sed -n '1,200p' wrangler.toml || true

      - name: Install wrangler CLI and publish
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          # install wrangler globally (Node 20)
          npm install -g wrangler
          wrangler --version

          # deploy (wrangler reads CLOUDFLARE_API_TOKEN from env)
          wrangler deploy
